<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>ğŸ•¹ï¸ Reinforce Lab ğŸ§ª</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='75'>ğŸ¤–</text></svg>">
  <!-- å¼•å…¥ TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.20.0.min.js"></script>

  <!-- Blockly -->
  <script src="https://unpkg.com/blockly/blockly.min.js"></script>


  <link rel="stylesheet" href="style.css">

</head>

<body>
  <!-- å·¦å´ï¼šå­éŠæˆ²å€ (å¯å…¨å±/åŠå±åˆ‡æ›) -->
  <div id="leftPanel">
    <!-- ä¸Šæ–¹æ§åˆ¶åˆ— (å¦‚ï¼šè¼‰å…¥ç¶²å€ã€æš«åœã€å…¨å±ç­‰) -->
    <div id="controls">
      <button id="toggleFullscreen">ğŸ•¹ï¸å…¨å±</button>
      <input id="gameUrlInput" type="text" value="https://colombo0718.neocities.org/graphicalGYM/games/Maze2D_emoji"
             placeholder="è¼¸å…¥éŠæˆ²ç¶²å€" />
      <button id="loadGame">â™»ï¸è¼‰å…¥</button>
      <button id="togglePause">â¸ï¸æš«åœ</button>
      <button id="toggleAccel">ğŸš€åŠ é€Ÿ</button>
    </div>

    <!-- ä¸‹æ–¹ iframeï¼šç”¨æ–¼åµŒå…¥å­éŠæˆ² -->
    <iframe id="game-iframe" src="https://colombo0718.neocities.org/graphicalGYM/games/Maze2D_emoji"></iframe>
  </div>

  <!-- å³å´ï¼šçˆ¶å¹³å° (å¤š Agentã€å¤š Tabs) -->
  <div id="rightPanel">

    <!-- Tabs æŒ‰éˆ•åˆ— -->
    <div class="sub-tab-buttons">
      <button class="sub-tab-link active" data-subtab="tutorial">ğŸ’¡æŒ‡å—</button>
      <!-- Agent1 -->
      <span class="agent-label">Agent 1:</span>
      <button id='me' class="sub-tab-link" data-subtab="p1-config">ğŸ› ï¸è¨­å®š</button>
      <button class="sub-tab-link" data-subtab="p1-qtable">ğŸ“Šåˆ†æ</button>
      <button class="sub-tab-link" data-subtab="p1-replay">ğŸ“½ï¸éŒ„æ”¾</button>
      <!-- <button class="sub-tab-link" data-subtab="p1-blocks">ğŸ§©ç¨‹å¼</button> -->


      <!-- Agent2 -->
      <span class="agent-label">Agent 2:</span>
      <button class="sub-tab-link" data-subtab="p2-config">ğŸ› ï¸è¨­å®š</button>
      <button class="sub-tab-link" data-subtab="p2-qtable">ğŸ“Šåˆ†æ</button>
      <button class="sub-tab-link" data-subtab="p2-replay">ğŸ“½ï¸éŒ„æ”¾</button>
      <!-- <button class="sub-tab-link" data-subtab="p2-blocks">ğŸ§©ç¨‹å¼</button> -->

    </div>

    <!-- Tabs å°æ‡‰çš„å…§å®¹å€ (å…±6å¡Š) -->
    <div id="tutorial" class="sub-tab-content active" >
      AI Reinforce Lab: Explore. Train. Compete.
      <p>é¸æ“‡ä¸‹åˆ—éŠæˆ²å¿«é€Ÿè¼‰å…¥ï¼š</p>
      <div>
        <button class="quick-load-button" data-url="https://colombo0718.neocities.org/graphicalGYM/games/MAB">ğŸ°Multi-Armed Bandit</button>
        <button id='game-maze' class="quick-load-button" data-url="https://colombo0718.neocities.org/graphicalGYM/games/Maze1D">ğŸ“Maze1D</button>
        <button class="quick-load-button" data-url="https://colombo0718.neocities.org/graphicalGYM/games/Maze2D_emoji">ğŸ—ºï¸Maze2D</button>
        <br>
        <button class="quick-load-button" data-url="https://colombo0718.neocities.org/graphicalGYM/games/dinasourCheck">ğŸ¦–Dinosaur Jump</button>
        <button class="quick-load-button" data-url="https://colombo0718.neocities.org/graphicalGYM/games/beatInfo">ğŸ¥Taiko Beat</button>
        <button class="quick-load-button" data-url="https://colombo0718.neocities.org/graphicalGYM/games/easyShoot">ğŸ¯Easy Shoot</button>
        <br>
        <button class="quick-load-button" data-url="https://colombo0718.neocities.org/graphicalGYM/games/fighterPlane">âœˆï¸space fighter</button>
        <button class="quick-load-button" data-url="https://colombo0718.neocities.org/graphicalGYM/games/magic">ğŸ§™ Magic Duel</button>
      </div>
    </div>






    <!-- 1. p1-config -->
    <div id="p1-config" class="sub-tab-content" >
      <!-- å­¸ç¿’æ–¹æ³•é¸æ“‡ -->
        <label>å­¸ç¿’æ–¹æ³•:</label><br>
        <input type="radio" id="algorithm-qtable" name="algorithm" value="Qtable" checked onchange="handleSelection()">
        <label for="algorithm-qtable">Q-Table</label>
        <input type="radio" id="algorithm-dqn" name="algorithm" value="DQN" onchange="handleSelection()">
        <label for="algorithm-dqn">DQN</label>
        <br><br>

        <!-- æ¢ç´¢ç­–ç•¥é¸æ“‡ -->
        <label>æŠ‰æ“‡ç­–ç•¥:</label><br>
        <input type="radio" id="strategy-egreedy" name="strategy" value="egreedy" checked onchange="handleStrategySelection()">
        <label for="strategy-egreedy">Îµ-greedy</label>
        <input type="radio" id="strategy-softmax" name="strategy" value="softmax" onchange="handleStrategySelection()">
        <label for="strategy-softmax">Softmax</label>
        <br><br>
      <!-- <label>Q-Learning æ›´æ–°å…¬å¼ï¼š</label><br>
      <img src="q_learning_formula.png" alt="Q-learning æ›´æ–°å…¬å¼">
      <br><br> -->
      <label for="learning-rate-slider">å­¸ç¿’ç‡ (Î±):</label>
      <input id="learning-rate-slider" type="range" min="0" max="1" step="0.05" value="0.5"
             oninput="updateValue('Alpha', this.value)">
      <span class="value-display" id="alpha-value">0.5</span>
      <br>

      <label for="discount-factor-slider">å›æœ”ç‡ (Î³):</label>
      <input id="discount-factor-slider" type="range" min="0" max="0.95" step="0.05" value="0.95"
             oninput="updateValue('Gamma', this.value)">
      <span class="value-display" id="gamma-value">0.95</span>
      <br>

      <label for="exploration-rate-slider">æ¢ç´¢ç‡ (Îµ):</label>
      <input id="exploration-rate-slider" type="range" min="0" max="1" step="0.05" value="0.2"
             oninput="updateValue('Epsilon', this.value)">
      <span class="value-display" id="epsilon-value">0.2</span>
      <br>
      <!-- ç’°å¢ƒè¶…åƒæ•¸ -->
      <label for="optimism-slider">æ¨‚è§€å€¼ (Ïˆ):</label>
      <input id="optimism-slider" type="range" min="-1" max="1" step="0.1" value="0"
             oninput="updateValue('Psi', this.value)">
      <span class="value-display" id="psi-value">0</span>
      <br><br>

      <label for="delay-slider">å»¶é²é‡(ms):</label>
      <input id="delay-slider" type="range" min="0" max="100" step="10" value="50"
             oninput="updateValue('delayTime', this.value)">
      <span class="value-display" id="delaytime-value">50</span>
      <!-- ç¬¬ä¸€å€ï¼šCumulative Reward Chart -->
      <div class="grid-container">
        <div id="p1-second-reward" class="chart"></div>  <!-- å·¦ä¸Š -->
        <div id="p1-second-steps" class="chart"></div>   <!-- å³ä¸Š (gauge) -->
        <div id="p1-episode-reward" class="chart"></div> <!-- å·¦ä¸‹ -->
        <div id="p1-episode-steps" class="chart"></div>  <!-- å³ä¸‹ -->
      </div>
    </div>
    <!-- 2. p1-blocks -->
    <div id="p1-qtable" class="sub-tab-content">

      <div class="grid-container">
        <div style="width: 100%; " id="p1-ui1">
          <button onclick="exportQtable()" style="margin: 5px ;">Export Q-table</button>
          <input type="file" style="margin: 5px ;" id="importQtableInput" accept=".json,.txt"
         onchange="importQtable(event)" />

          <h4>é¡¯ç¤ºåœ–è¡¨</h4>
          <input type="checkbox" id="actionSelection" checked>
          <label for="actionPrefer">å‹•ä½œåå¥½</label><br>

          <input type="checkbox" id="valueBounds" checked>
          <label for="valueBounds">æ¥µå€¼åˆ†å¸ƒ</label><br>

          <input type="checkbox" id="pointLineAnalysis" checked>
          <label for="pointLine">é»ç·šè§£æ</label>
        </div>
        <div id="p1-ui2">
          <label for="x-axis">X è»¸ç¶­åº¦:</label>
          <select id="x-axis">
            <option value="0">ç¶­åº¦ 0</option>
            <option value="1">ç¶­åº¦ 1</option>
            <option value="2">ç¶­åº¦ 2</option>
          </select>

          <label for="y-axis">Y è»¸ç¶­åº¦:</label>
          <select id="y-axis">
            <option value="0">ç¶­åº¦ 0</option>
            <option value="1">ç¶­åº¦ 1</option>
            <option value="2">ç¶­åº¦ 2</option>
          </select>



          <h4>åˆ‡ç‰‡ä½ç½®  </h4>
          <input type="checkbox" id="tracking">
          <label for="tracking">è·Ÿéš¨ç•¶ä¸‹</label></br></br>

          <label for="dim0">ç¶­åº¦ 0:</label>
          <input type="range" id="dim0" min="0" max="19" value="0">
          <span id="dim0-value">0</span><br>

          <label for="dim1">ç¶­åº¦ 1:</label>
          <input type="range" id="dim1" min="0" max="19" value="0">
          <span id="dim1-value">0</span><br>

          <label for="dim2">ç¶­åº¦ 2:</label>
          <input type="range" id="dim2" min="0" max="19" value="0">
          <span id="dim2-value">0</span><br>


        </div>
        <div id="p1-diff-value" class="chart"></div>
        <div id="p1-acti-color" class="chart"></div>
        <div id="p1-maxi-value" class="chart"></div>
        <div id="p1-mini-value" class="chart"></div>
        <div id="p1-line-value" class="chart"></div>
        <div id="p1-bars-value" class="chart"></div>
      </div>
    </div>

    <div id="p1-blocks" class="sub-tab-content">
        <div id="p1-blocklyDiv"></div>
    </div>
    <!-- 4. p1-logs -->
    <div id="p1-logs" class="sub-tab-content">

    </div>





    <!-- 4. p2-blocks -->
    <div id="p2-blocks" class="sub-tab-content" >
      <div id="p2-blocklyDiv"></div>
    </div>
    <!-- 5. p2-config -->
    <div id="p2-config" class="sub-tab-content" >
      <div style="width:100%; height: 33%">
        <canvas id="p2-rewards-chart"></canvas>

      </div>

      <div style="width:100%; height: 33%">
        <canvas id="p2-qValues-chart"></canvas>
      </div>
    </div>
    <!-- 6. p2-logs -->
    <div id="p2-logs" class="sub-tab-content" >
    </div>


  </div>

  <!-- (å¯é¸) jQuery UI Dialog ç”¨æ–¼é¡¯ç¤º Q å€¼åœ–è¡¨çš„å½ˆçª— (è‹¥è¦ç”¨å½ˆçª—) -->


  <!-- ================================ -->
  <!-- JS å€æ®µï¼šåŒ…æ‹¬ å…¨å±åˆ‡æ›ã€å¤š Tabs æ§åˆ¶ã€Q-Learningç¨‹å¼é‚è¼¯ã€Blocklyåˆå§‹è¨­å®š ç­‰ -->
  <!-- ================================ -->
  <script>
    /***************************************************
     * [1] å…¨å± / åŠå± åˆ‡æ›åŠŸèƒ½
     ***************************************************/
    const leftPanel = document.getElementById("leftPanel");
    const rightPanel = document.getElementById("rightPanel"); // å–å¾—å³å´é¢æ¿
    const fullscreenButton = document.getElementById("toggleFullscreen");

    fullscreenButton.addEventListener("click", () => {
      if (leftPanel.classList.contains("fullscreen")) {
        // è‹¥ç›®å‰å…¨å±ï¼Œå‰‡æ¢å¾©
        leftPanel.classList.remove("fullscreen");
        rightPanel.style.display = "flex";
        fullscreenButton.textContent = "ğŸ•¹ï¸å…¨å±";
      } else {
        // é€²å…¥å…¨å±
        leftPanel.classList.add("fullscreen");
        rightPanel.style.display = "none"; // éš±è—å³å´é¢æ¿
        fullscreenButton.textContent = "ğŸ§ªåŠå±";
      }
    });

    /***************************************************
     * [2] å·¦å´ï¼šè¼‰å…¥/æš«åœ/ç¹¼çºŒ ç­‰æ§åˆ¶
     ***************************************************/
    const loadGameBtn = document.getElementById("loadGame");
    const gameUrlInput = document.getElementById("gameUrlInput");
    const gameIframe = document.getElementById("game-iframe");
    const togglePauseBtn = document.getElementById("togglePause");
    const toggleAccelBtn = document.getElementById("toggleAccel");

    loadGameBtn.addEventListener("click", () => {
      const url = gameUrlInput.value.trim();
      if (url) {
        gameIframe.src = url;
      }
      isPaused = false;
      togglePauseBtn.textContent = "â¸ï¸æš«åœ";
      // gameIframe.addEventListener("load", () => {
      //   // const iframe = document.getElementById("game-iframe");
      //   gameIframe.contentWindow.postMessage({ type: "questInfo" }, "*");
      // }, { once: true }); // ä½¿ç”¨ { once: true } ç¢ºä¿äº‹ä»¶åƒ…åŸ·è¡Œä¸€æ¬¡
    });

    let isPaused = false;
    togglePauseBtn.addEventListener("click", () => {
      if (!isPaused) {
        // é€™è£¡å¯åšæš«åœéŠæˆ² or åœæ­¢è¨“ç·´çš„å‹•ä½œ
        gameIframe.contentWindow.postMessage({ type: "pause" }, "*");
        togglePauseBtn.textContent = "â–¶ï¸ç¹¼çºŒ";

      } else {
        // é€™è£¡å¯åšæ¢å¾©éŠæˆ² or ç¹¼çºŒè¨“ç·´çš„å‹•ä½œ
        gameIframe.contentWindow.postMessage({ type: "pause" }, "*");
        gameIframe.contentWindow.postMessage({ type: "action",action:0}, "*");
        console.log('keep go')
        togglePauseBtn.textContent = "â¸ï¸æš«åœ";
      }
      isPaused = !isPaused;
    });

    let isAccel = false;
    toggleAccelBtn.addEventListener("click", () => {
      if (!isAccel) {
        // é€™è£¡å¯åšæš«åœéŠæˆ² or åœæ­¢è¨“ç·´çš„å‹•ä½œ
        gameIframe.contentWindow.postMessage({ type: "accel" }, "*");
        toggleAccelBtn.textContent = "ğŸ¢æ­£å¸¸";
        delayTime=basicDelayTime/5
      } else {
        // é€™è£¡å¯åšæ¢å¾©éŠæˆ² or ç¹¼çºŒè¨“ç·´çš„å‹•ä½œ
        gameIframe.contentWindow.postMessage({ type: "accel" }, "*");
        toggleAccelBtn.textContent = "ğŸš€åŠ é€Ÿ";
        delayTime=basicDelayTime
      }
      isAccel = !isAccel;
    });

    /***************************************************
     * [3] å¤š Agent å¤š Tabs åˆ‡æ›
     ***************************************************/
    const subTabLinks = document.querySelectorAll(".sub-tab-link");
    const subTabContents = document.querySelectorAll(".sub-tab-content");

    subTabLinks.forEach(link => {
      link.addEventListener("click", () => {
        // å…ˆç§»é™¤å…¨éƒ¨ active
        subTabLinks.forEach(l => l.classList.remove("active"));
        subTabContents.forEach(c => c.classList.remove("active"));

        // å•Ÿç”¨ç•¶å‰è¢«é»æ“Šçš„
        link.classList.add("active");
        const target = link.getAttribute("data-subtab");
        document.getElementById(target).classList.add("active");

            // æª¢æŸ¥æ˜¯å¦éœ€è¦é‡æ–°æ¸²æŸ“ Blockly
            if (target === "p1-blocks" && workspace1) {
              Blockly.svgResize(workspace1);
            }
            if (target === "p2-blocks" && workspace2) {
              Blockly.svgResize(workspace2);
            }
      });
    });


    // å¿«é€Ÿè¼‰å…¥éŠæˆ²æŒ‰éˆ•
    document.querySelectorAll('.quick-load-button').forEach(button => {
      button.addEventListener('click', () => {
        const url = button.getAttribute('data-url');
        if (url) {
          gameUrlInput.value= url
          gameIframe.src = url; // è¨­å®š iframe çš„ src
        }
        isPaused = false;
        togglePauseBtn.textContent = "â¸ï¸æš«åœ";
      });
    });



    // æ±ºå®šæ˜¯å¦ç•«åœ–è¡¨ ***********************************

    let plotGeneralCharts=true
    let plotQualityCharts=true

    /***************************************************
     * [4] Blockly åˆå§‹åŒ–
     ***************************************************/
    // var workspace1 = Blockly.inject('p1-blocklyDiv', {
    //   toolbox:
    //     `<xml>
    //       <block type="controls_repeat_ext"></block>
    //       <block type="math_number"></block>
    //       <block type="math_arithmetic"></block>
    //       <block type="logic_compare"></block>
    //       <block type="variables_get"></block>
    //       <block type="variables_set"></block>
    //       <block type="controls_if"></block>
    //       <block type="text_print"></block>
    //      </xml>`,
    //   trashcan: true,
    //   theme: Blockly.Themes.Zelos,
    //   renderer: 'thrasos',
    // });
    //
    // // é è¼‰ä¸€äº›ç©æœ¨
    // const initialBlocks =
    //   `<xml>
    //     <block type="controls_repeat_ext" x="20" y="20">
    //       <value name="TIMES">
    //         <shadow type="math_number">
    //           <field name="NUM">5</field>
    //         </shadow>
    //       </value>
    //       <statement name="DO">
    //         <block type="text_print">
    //           <value name="TEXT">
    //             <shadow type="text">
    //               <field name="TEXT">Q-Learning</field>
    //             </shadow>
    //           </value>
    //         </block>
    //       </statement>
    //     </block>
    //   </xml>`;
    // loadInitialBlocks(initialBlocks, workspace1);
    //
    // function loadInitialBlocks(xmlText, workspace) {
    //   const parser = new DOMParser();
    //   const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
    //   Blockly.Xml.domToWorkspace(xmlDoc.documentElement, workspace);
    // }
    //
    //
    // var workspace2 = Blockly.inject('p2-blocklyDiv', {
    //   toolbox:
    //     `<xml>
    //       <block type="controls_repeat_ext"></block>
    //       <block type="math_number"></block>
    //       <block type="math_arithmetic"></block>
    //       <block type="logic_compare"></block>
    //       <block type="variables_get"></block>
    //      </xml>`,
    //   trashcan: true,
    //   theme: Blockly.Themes.Zelos,
    //   renderer: 'thrasos',
    // });
    //
    //
    //     // // é è¼‰ä¸€äº›ç©æœ¨
    // const initialBlocks2 =
    //   `<xml>
    //     <block type="controls_repeat_ext" x="20" y="20">
    //       <value name="TIMES">
    //         <shadow type="math_number">
    //           <field name="NUM">5</field>
    //         </shadow>
    //       </value>
    //       <statement name="DO">
    //         <block type="text_print">
    //           <value name="TEXT">
    //             <shadow type="text">
    //               <field name="TEXT">Q-Learning</field>
    //             </shadow>
    //           </value>
    //         </block>
    //       </statement>
    //     </block>
    //   </xml>`;
    // loadInitialBlocks(initialBlocks, workspace2);

// åƒ¹å€¼å‡½æ•¸é€šç”¨ =============================

    let QTable = {};
    let Alpha   = .5;  // å­¸ç¿’ç‡
    let Gamma   = 0.95; // æŠ˜æ‰£å› å­
    let Epsilon = .1;  // æ¢ç´¢ç‡
    let Psi     = 0;    // æ¨‚è§€å€¼

    let basicDelayTime =50 ,delayTime =50

        // æ›´æ–° UI å’Œè®Šæ•¸
  function updateValue(parameter, value) {
  value = parseFloat(value);

  switch (parameter) {
    case "Alpha":
      Alpha = value;
      break;
    case "Gamma":
      Gamma = value;
      break;
    case "Epsilon":
      Epsilon = value;
      break;
    case "Psi":
      Psi = value;
      break;
    case "delayTime":
      basicDelayTime = value;
      break;
    default:
      console.warn(`æœªçŸ¥åƒæ•¸: ${parameter}`);
  }

  // æ›´æ–°å°æ‡‰çš„ HTML é¡¯ç¤ºæ•¸å€¼
  let targetSpan = document.getElementById(parameter.toLowerCase() + "-value");
  if (targetSpan) {
    targetSpan.textContent = value;
  }

  console.log(`${parameter} æ›´æ–°ç‚º ${value}`);
  console.log([Alpha,Gamma,Epsilon,Psi,basicDelayTime])
}

//     /***************************************************
//      * [6] çˆ¶/å­é é¢ postMessage é€šè¨Šï¼š
//      *     æ¥æ”¶å­é é¢ (éŠæˆ²)å‚³å›çš„ (reward, state)ï¼Œä¸¦å›å‚³å‹•ä½œ
//      ***************************************************/
    let stateInfo
    let actionInfo
    let state_size
    let action_size
//
//     // æ¯ç•¶éŠæˆ²é é¢è¼‰å…¥å®Œæˆï¼Œå°±è©¢å•éŠæˆ²è³‡è¨Š
    gameIframe.addEventListener("load", () => {
      gameIframe.contentWindow.postMessage({ type: "questInfo" }, "*");
    });
//
    window.addEventListener("message", (event) => {
      const message = event.data;

      if (message.type === "gameInfo") {
        console.log(message)
        stateInfo=message.players[0].stateInfo
        actionInfo=message.players[0].actionInfo
        // writeLog(1,stateInfo)
        // writeLog(1,actionInfo)
        state_size=stateInfo.length
        action_size=actionInfo[0].level
        // console.log(stateInfo)
        // åƒ¹å€¼å‹ç®—æ³•å°ˆå±¬
        QTable = {};     // æ¸…ç©ºQè¡¨
        stateRange = []; // æ¸…ç©ºç‹€æ…‹ç¯„åœ
        numBins = [];    // æ¸…ç©ºæ¯è»¸æ¡¶æ•¸
        message.players[0].stateInfo.forEach((info) => {
          stateRange.push({ min: info.min, max: info.max });
          if(info.bin){
            numBins.push(info.bin);
          }else{
            numBins.push(20); // é è¨­æ¯å€‹ç‹€æ…‹åˆ†æˆ 20 æ¡¶ï¼Œå¯æ ¹æ“šéœ€æ±‚èª¿æ•´
          }
        });

        // å°‡ stateRange å’Œ numBins å‚³éåˆ° Web Worker
        syncStateInfoToWorker();
        // åˆå§‹åŒ–DQN
        // initializeDQNModel();
        // ç™¼é€ç¬¬ä¸€å€‹å‹•ä½œ
        gameIframe.contentWindow.postMessage({ type: "action", action: 0 }, "*");
      }

    });



    let prevAction,prevState
    let nextAction,nextState
    let reward
//
//
//
    function evaluateQuality(State){
      let qArray1=getQArrayFromTable(State)
      // let qArray2=getQArrayFromDQNet(State)
      return qArray1
      return new Promise((resolve) => {
        pendingPredictResolve = resolve;
        dqnWorker.postMessage({ type: 'predict', data: nextState });
      });
    }

    function planningStrategy(qArray){
      let strategy1=eGreedyStrategy(qArray)
      let strategy2=softmaxStrategy(qArray)
      return strategy1
    }

    function learnOneStep(prevState, prevAction, reward, nextState,nextAction){
      if(Number.isInteger(prevAction)){
        //qtable å­¸ç¿’
        qTableUpdate(prevState, prevAction, reward, nextState,nextAction);
        // dqn å­¸ç¿’
        // addToBuffer(prevState, prevAction, reward, nextState, nextAction);
        // trainDQN();
      }
    }

    const traceLength = 5; // å›ºå®šè»Œè·¡é•·åº¦ï¼Œä¾‹å¦‚ 20 æ­¥
    let trace = []; // è»Œè·¡é™£åˆ—ï¼Œç”¨ä¾†å„²å­˜ç¶“é©—

    function recordStep(prevState, prevAction, reward, nextState, nextAction) {
      const step = [prevState, prevAction, reward, nextState, nextAction];
      trace.unshift(step); // å¾é ­å¡å…¥æ–°ç¶“é©—
      if (trace.length > traceLength) trace.pop(); // å¦‚æœè¶…éé•·åº¦ï¼Œç§»é™¤æœ€èˆŠç¶“é©—
    }

    // é€å€‹å›æº¯å­¸ç¿’
    function learnFromTrace() {
      // console.log(trace,trace.length)
      for (let i = 0; i < trace.length; i++) {
        // console.log(i)
        const [prevState, prevAction, reward, nextState, nextAction] = trace[i];
        learnOneStep(prevState, prevAction, reward, nextState, nextAction);
      }
    }

    // DQN Web Worker ç›¸é—œ-------------------------------
    // åˆå§‹åŒ– Web Worker
    const dqnWorker = new Worker('dqnWebWorker.js');

    // ä¸»åŸ·è¡Œç·’
    // dqnWorker.onmessage = (event) => {
    //   if (event.data.type === 'log') {
    //     console.log("[Worker Log]:", event.data.message);
    //   }
    // };

    // åŒæ­¥ QTable æ•¸æ“šåˆ° Worker
    let lastSyncedQTable = {};
    function syncQTableToWorker() {
      const updates = {};
      for (let [key, value] of Object.entries(QTable)) {
        if (lastSyncedQTable[key] !== value) {
          updates[key] = value;
        }
      }
      if (Object.keys(updates).length > 0) {
        dqnWorker.postMessage({ type: 'updateQTable', data: updates });
        lastSyncedQTable = { ...QTable };
      }
    }

    // å‚³é stateInfo ç›¸é—œæ•¸æ“šåˆ° Worker
    function syncStateInfoToWorker() {
      dqnWorker.postMessage({
        type: 'updateStateInfo',
        data: { stateRange, numBins }
      });
    }

    // å¾ Worker ç²å– DQN é æ¸¬çš„ Q å€¼
    let pendingPredictResolve = null;
    // 
    dqnWorker.onmessage = (event) => {
      if (event.data.type === 'log') {
        console.log("[Worker Log]:", event.data.message);
      }else if (event.data.type === 'predictResult') {
        if (pendingPredictResolve) {
          pendingPredictResolve(event.data.qValues);
          pendingPredictResolve = null;
        }
      } else if (event.data.type === 'fitDone') {
        console.log("DQN æ“¬åˆå®Œæˆ");
      }
    };
    dqnWorker.onerror = (error) => {
      console.error("Web Worker éŒ¯èª¤:", error);
    };


    let frameNumber=0
    // éŠæˆ²éç¨‹ä¸­çš„æ¯ä¸€æ¬¡å¾ªç’°ï¼Œå¾æ¥æ”¶åˆ°æ–°çš„reward stateé–‹å§‹
    window.addEventListener("message", async(event) => {
      const message = event.data;
      // å¾éŠæˆ²å­é é¢æ‹¿åˆ°å ±é…¬èˆ‡ç‹€æ…‹
      if (message.type === "reward_state"){


        // å‹•æ…‹èª¿æ•´åˆ»æ„å»¶é²
        // if(frameNumber<basicDelayTime/10){delayTime+=1}
        // else if(frameNumber>basicDelayTime/10){delayTime-=1}

        // å®šæœŸåŒæ­¥ QTable åˆ° Worker
        if (episodeSteps % 10 === 0) {
          // await syncQTableToWorker();
        }


        // å–å¾—ç•¶ä¸‹å ±é…¬
        reward = message.reward;
        // å–å¾—ç•¶ä¸‹ç‹€æ…‹
        nextState=message.state
        // åŠ å…¥æ¯ç§’å ±é…¬ç´¯è¨ˆ
        secondReward += reward;
        // ä¸€ç§’å…§æ­¥æ•¸+1
        secondSteps += 1
        // åŠ å…¥å›åˆå ±é…¬ç´¯è¨ˆ
        episodeReward += reward;
        
        episodeSteps += 1;// å›åˆæ­¥æ•¸+1

        // await DQNfitToQTable();
        // 1.è©•ä¼°åƒ¹å€¼
        let qArray = evaluateQuality(nextState)
        // 2.æ“¬å®šç­–ç•¥
        let strategy=planningStrategy(qArray)
        // 3.é¸æ“‡å‹•ä½œ
        nextAction = selectAction(strategy)
        // 4.æ¶ˆåŒ–å­¸ç¿’
        recordStep(prevState, prevAction, reward, nextState, nextAction)
        if(reward!==0){ //ç²å¾—å¯¦éš›çå‹µ
          learnFromTrace() 
        }else{
          learnOneStep(prevState, prevAction, reward, nextState,nextAction) // æ›´æ–°å–®æ­¥
        }

        // ç¹¼æ‰¿ç‹€æ…‹èˆ‡å‹•ä½œè³‡è¨Š
        prevState = nextState
        prevAction   = nextAction;

        frameNumber=0

        // å›å‚³å‹•ä½œçµ¦å­é é¢
        if(isPaused){return}
        setTimeout(() => {
          gameIframe.contentWindow.postMessage({
            type: "action",
            action: nextAction
          }, "*");
        // æ•…æ„è¨­ç½®çš„å»¶é²æ™‚é–“
        }, delayTime);
      }

      if (message.type === "frame"){
        frameNumber+=1
      }

      if (message.type === "endEpisode"){
        if(plotGeneralCharts){
          updateEpisodeChart()
        }
        episodeCount += 1
        episodeReward=0
        episodeSteps=0
        // trace = []
        // if(plotGeneralCharts){
        //   updateEpisodeChart()
        // }
        // updateEpisodeChart()
      }
    });


    /***************************************************
     * [7] ARS (Action, Reward, State) æ—¥èªŒç´€éŒ„
     ***************************************************/


    // let lastTime = null;

    // function updateARSLog(agentId,action, reward, state) {
    //   const now = new Date();
    //   let dt = lastTime ? now - lastTime : 0;
    //   lastTime = now;
    //   let sIndex = getStateKey(state);

    //   // Create the log entry
    //   const logEntry = `dt=${dt}ms, A=${action}, R=${reward}, state=${state}, sIndex=${sIndex}`;

    //   // Write the log for the specified agent
    //   writeLog(agentId, logEntry);
    // }

    // function writeLog(agentId, logEntry) {
    //   // Get the log element for the specified agent
    //   const logElement = document.getElementById(`p${agentId}-logs`);
    //   if (!logElement) {
    //     console.error(`Log element for agent ${agentId} not found.`);
    //     return;
    //   }

    //   // Append the log entry
    //   logElement.textContent += (logElement.textContent ? "\n" : "") + logEntry;

    //   // Automatically scroll to the bottom
    //   logElement.scrollTop = logElement.scrollHeight;
    // }




/***************************************************
 * é€šç”¨åœ–è¡¨å…¨å±€è®Šæ•¸ (è«‹ç¢ºä¿é€™äº›è®Šæ•¸åœ¨å…¶ä»–é‚è¼¯ä¸­ä¹Ÿæœ‰é©ç•¶æ›´æ–°)
 ***************************************************/
let secondReward = 0;    // æ¯ç§’ç´¯è¨ˆ Rewardï¼Œå…¶ä»–é‚è¼¯ä¸­éœ€è¦ç´¯åŠ æ­¤å€¼
let secondSteps  = 0;    // æ¯ç§’ç´¯è¨ˆæ­¥æ•¸ï¼Œå…¶ä»–é‚è¼¯ä¸­éœ€è¦ç´¯åŠ æ­¤å€¼

let rewardData   = [];
let rewardLabels = [];
let stepsData    = [];
let stepsLabels  = [];

let startTime = Date.now();

// æ¯å›åˆæ•¸æ“šï¼ˆepisodeï¼‰ç›¸é—œè®Šæ•¸
let episodeIndex      = [];  // å›åˆç·¨è™Ÿ
let episodeRewardData = [];  // æ¯å›åˆç´¯ç© Reward
let episodeStepsData  = [];  // æ¯å›åˆç´¯ç©æ­¥æ•¸

// å‡è¨­é€™äº›è®Šæ•¸åœ¨æ¯å›åˆçµæŸæ™‚è¢«æ›´æ–°ï¼š
let episodeCount = 1;    // ç•¶å‰å›åˆç·¨è™Ÿ
let episodeReward = 0;   // ç•¶å‰å›åˆç´¯ç© Reward
let episodeSteps  = 0;   // ç•¶å‰å›åˆç´¯ç©æ­¥æ•¸

/***************************************************
 * [10] QTable Export / Import
 ***************************************************/

 function exportQtable() {
  // å°‡ QTable åºåˆ—åŒ–ç‚º JSON å­—ä¸²
  const dataStr = JSON.stringify(QTable, null, 2);
  // å»ºç«‹ä¸€å€‹ Blob ç‰©ä»¶ï¼Œå‹æ…‹ç‚º text/plain æˆ– application/json
  const blob = new Blob([dataStr], { type: "application/json" });
  // å»ºç«‹è‡¨æ™‚é€£çµä¸¦é»æ“Šï¼Œè§¸ç™¼ä¸‹è¼‰
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = "Qtable.json"; // æª”åå¯è‡ªè¨‚
  link.click();
  URL.revokeObjectURL(url);
}

function importQtable(evt) {
  const file = evt.target.files[0];me
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const fileContent = e.target.result;
      // è§£æ JSON
      const obj = JSON.parse(fileContent);

      // å¦‚æœæª”æ¡ˆè£¡åªæœ‰ QTable ç‰©ä»¶
      QTable = obj;

      console.log("QTable imported successfully:", QTable);
      // alert("QTable å·²æˆåŠŸè¼‰å…¥ï¼Œå¾ŒçºŒè¨“ç·´å¯æ²¿ç”¨æ­¤è¡¨æ ¼ã€‚");

    } catch (error) {
      console.error("Error parsing QTable file", error);
      // alert("ç„¡æ³•è§£ææ­¤ QTable æª”æ¡ˆ");
    }
  };
  reader.readAsText(file, "utf-8");
}

  </script>
  <script src="./generalCharts.js"></script>
  <script src="./qualityCharts.js"></script>
  <script src="./reinforceEngine.js"></script>
</body>
</html>
