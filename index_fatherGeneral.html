<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>ğŸ•¹ï¸ Reinforce Lab ğŸ§ª</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='75'>ğŸ¤–</text></svg>">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.20.0.min.js"></script>

  <!-- Blockly -->
  <script src="https://unpkg.com/blockly/blockly.min.js"></script>

  <style>
    /************************************************************
     * æ•´é«”é é¢ä½ˆå±€ï¼šbodyä½¿ç”¨flex
     ************************************************************/
    body {
      margin: 0;
      padding: 0;
      font-family: Consolas, sans-serif;
      height: 100vh; /* è‹¥éœ€è¦æ•´é æ»¿ç‰ˆï¼Œå¯ç”¨ 100vhï¼›è‹¥éœ€è¦å¯æ²å‹•ï¼Œå‰‡ç§»é™¤ã€‚ */
      display: flex;
    }

    /************************************************************
     * å·¦å´ï¼šå­éŠæˆ² (iframe) å€åŸŸ
     ************************************************************/
    #leftPanel {
      width: 40%;               /* é è¨­ 30% (æˆ–æ ¹æ“šéœ€æ±‚èª¿æˆ40%) */
      flex-shrink: 0;          /* é¿å…è¦–çª—ç¸®å°æ™‚è¢«å£“ç¸® */
      display: flex;
      flex-direction: column;
      border-right: 1px solid #ddd;
      transition: width 0.3s ease; /* å…¨å±/åŠå±è½‰æ›å‹•ç•« */
    }

    /* è‹¥æŒ‰ä¸‹ã€Œå…¨å±ã€æ™‚ï¼Œåˆ‡æ› classï¼Œç½®æ–¼é ‚å±¤ã€å¯¬é«˜100%ï¼Œä¸¦é–å®šä½ç½® */
    #leftPanel.fullscreen {
      width: 100vw;  /* å…¨è¢å¹•å¯¬åº¦ */
      height: 100vh; /* å…¨è¢å¹•é«˜åº¦ */
      position: fixed;
      top: 0;
      left: 0;
      z-index: 999;  
    }

    /* å·¦å´ä¸Šæ–¹æ§åˆ¶åˆ— (å›ºå®šé«˜åº¦ 35pxï¼Œå‚ç›´ç½®ä¸­) */
    #controls {
      display: flex;
      align-items: center;
      height: 35px;
      background-color: #cfe;
      border-bottom: 1px solid #ddd;
      padding: 0 8px;
    }
    #controls button,
    #controls input {
      margin-right: 6px;
      padding: 4px 6px;
      font-size: 13px;
      line-height: 1;
    }
    #controls button:last-child,
    #controls input:last-child {
      margin-right: 0;
    }
    /* è®“è¼¸å…¥æ¡†å¯æ’é–‹å‰©é¤˜ç©ºé–“ */
    #gameUrlInput {
      flex-grow: 1;
    }

    /* å·¦å´ iframe (å­éŠæˆ²) */
    iframe {
      flex-grow: 1;   /* æ’æ»¿å‰©é¤˜ç©ºé–“ */
      width: 100%;
      border: none;
    }

    /************************************************************
     * å³å´ï¼šçˆ¶å¹³å° (å¤šAgent / å¤š Tabs)
     ************************************************************/
    #rightPanel {
      width: 70%;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }

    /* Tabs ä¸Šæ–¹çš„æŒ‰éˆ•åˆ— (å›ºå®šé«˜åº¦ 35px)ï¼Œèˆ‡åº•éƒ¨ç·šå°é½Š */
    .sub-tab-buttons {
      font-family: Consolas, sans-serif;
      display: flex;
      align-items: flex-end; /* è®“æŒ‰éˆ•èˆ‡å®¹å™¨åº•ç·£è²¼é½Š */
      height: 35px;
      background: #cef;
      border-bottom: 1px solid #ddd;
      padding: 0 8px;
    }

    /* ã€ŒAgent 1:ã€ç­‰æ¨™ç±¤ */
    .sub-tab-buttons .agent-label {
      display: inline-flex;
      align-items: center;
      margin-right: 8px;
      font-weight: bold;
      white-space: nowrap;
    }

    /* Tabs æŒ‰éˆ• */
    .sub-tab-buttons button {
      font-family: Consolas, sans-serif;
      margin-bottom: -1px; /* ç‚ºäº†è®“æŒ‰éˆ•åº•é‚Šèˆ‡å®¹å™¨å°é½Š */
      margin-right: 6px;
      min-height: 28px;
      padding: 4px 8px;
      font-size: 13px;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #e9e9e9;
      border: 1px solid #ccc;
      border-radius: 4px 4px 0 0;
      cursor: pointer;
      white-space: nowrap;
    }
    .sub-tab-buttons button:last-child {
      margin-right: 0;
    }
    .sub-tab-buttons button:hover {
      background: #ddd;
    }
    .sub-tab-buttons button.active {
      background: #fff;
      border-bottom: 1px solid #fff; /* è®“ active çš„æŒ‰éˆ•çœ‹èµ·ä¾†åƒã€Œæµ®èµ·ã€ */
      font-weight: bold;
      color: #0078d7;
    }
    
    /************************************************************
     * ä¸‹é¢æ˜¯æ¯å€‹Tabè£¡çš„ç´°éƒ¨å…§å®¹ï¼šBlockly / config / Logs ç­‰
    ************************************************************/

    /* 6 å€‹å°æ‡‰çš„ Tab å…§å®¹å€å¡Š */
    .sub-tab-content {
      display: none;
      flex-grow: 1;
      padding: 10px;
      background: #fff;
      overflow: auto;
    }
    .sub-tab-content.active {
      display: block;
    }


    /* æŒ‰éˆ•ç¾åŒ– */
    button {
      margin: 5px 0;
      padding: 6px 12px;
      cursor: pointer;
    }
    button:hover {
      background-color: #eee;
    }

    #p1-blocklyDiv, #p2-blocklyDiv {
      width: 100%;
      height: 100%;
    }
    .blocklyPath {
      stroke: white;
    }
    /* ARS ç´€éŒ„å€ */
    #p1-log {
      box-sizing: border-box;
      padding: 10px;
      overflow-y: auto;
      font-size: 14px;
      /* è®“æ›è¡Œç¬¦ \n ç”Ÿæ•ˆ */
      white-space: pre-wrap; 
    }



  </style>
</head>

<body>
  <!-- å·¦å´ï¼šå­éŠæˆ²å€ (å¯å…¨å±/åŠå±åˆ‡æ›) -->
  <div id="leftPanel">
    <!-- ä¸Šæ–¹æ§åˆ¶åˆ— (å¦‚ï¼šè¼‰å…¥ç¶²å€ã€æš«åœã€å…¨å±ç­‰) -->
    <div id="controls">
      <button id="toggleFullscreen">ğŸ•¹ï¸å…¨å±</button>
      <input id="gameUrlInput" type="text" value="https://colombo0718.neocities.org/graphicalGYM/games/dinasourCheck"
             placeholder="è¼¸å…¥éŠæˆ²ç¶²å€" />
      <button id="loadGame">â™»ï¸è¼‰å…¥</button>
      <button id="togglePause">â¸ï¸æš«åœ</button>
      <button id="toggleAccel">ğŸš€åŠ é€Ÿ</button>
    </div>

    <!-- ä¸‹æ–¹ iframeï¼šç”¨æ–¼åµŒå…¥å­éŠæˆ² -->
    <iframe id="game-iframe" src="https://colombo0718.neocities.org/graphicalGYM/games/dinasourCheck"></iframe>
  </div>

  <!-- å³å´ï¼šçˆ¶å¹³å° (å¤š Agentã€å¤š Tabs) -->
  <div id="rightPanel">
  
    <!-- Tabs æŒ‰éˆ•åˆ— -->
    <div class="sub-tab-buttons">
      <button class="sub-tab-link active" data-subtab="tutorial">ğŸ’¡æŒ‡å—</button>
      <!-- Agent1 -->
      <span class="agent-label">Agent 1:</span>
      <button id='me' class="sub-tab-link" data-subtab="p1-config">ğŸ› ï¸è¨­å®š</button>
      <button class="sub-tab-link" data-subtab="p1-qtable">ğŸ“Šåˆ†æ</button>
      <button class="sub-tab-link" data-subtab="p1-blocks">ğŸ§©ç©æœ¨</button>
      <button class="sub-tab-link" data-subtab="p1-logs">ğŸ“œç´€éŒ„</button>

      <!-- Agent2 -->
      <span class="agent-label">Agent 2:</span>
      <button class="sub-tab-link" data-subtab="p2-config">ğŸ› ï¸è¨­å®š</button>
      <button class="sub-tab-link" data-subtab="p2-qtable">ğŸ“Šåˆ†æ</button>
      <button class="sub-tab-link" data-subtab="p2-blocks">ğŸ§©ç©æœ¨</button>
      <button class="sub-tab-link" data-subtab="p2-logs">ğŸ“œç´€éŒ„</button>
      
      <!-- Agent3 -->
      <!--<span class="agent-label" style="margin-left: 16px;">Agent 3:</span>-->
      <!--<button class="sub-tab-link" data-subtab="p3-blocks">Blocks</button>-->
      <!--<button class="sub-tab-link" data-subtab="p3-config">config</button>-->
      <!--<button class="sub-tab-link" data-subtab="p3-logs">Logs</button>-->
      
      <!-- Agent4 -->
      <!--<span class="agent-label" style="margin-left: 16px;">Agent 4:</span>-->
      <!--<button class="sub-tab-link" data-subtab="p4-blocks">Blocks</button>-->
      <!--<button class="sub-tab-link" data-subtab="p4-config">config</button>-->
      <!--<button class="sub-tab-link" data-subtab="p4-logs">Logs</button>-->
      

    </div>

    <!-- Tabs å°æ‡‰çš„å…§å®¹å€ (å…±6å¡Š) -->
    <div id="tutorial" class="sub-tab-content active" >
      AI Reinforce Lab: Explore. Train. Compete.
      <p>é¸æ“‡ä¸‹åˆ—éŠæˆ²å¿«é€Ÿè¼‰å…¥ï¼š</p>
      <div>
        <button class="quick-load-button" data-url="https://colombo0718.neocities.org/graphicalGYM/games/MAB">Multi-Armed Bandit</button>
        <button class="quick-load-button" data-url="https://colombo0718.neocities.org/graphicalGYM/games/dinasourCheck">Dinosaur Jump</button>
        <button class="quick-load-button" data-url="https://colombo0718.neocities.org/graphicalGYM/games/beatInfo">Taiko Beat</button>
        <button class="quick-load-button" data-url="https://colombo0718.neocities.org/graphicalGYM/games/easyShoot">Easy Shoot</button>
        <button id='game-maze' class="quick-load-button" data-url="https://colombo0718.neocities.org/graphicalGYM/games/Maze2D">Maze2D</button>
      </div>
    </div>
    
    
    
    
    

    <!-- 1. p1-config -->
    <div id="p1-config" class="sub-tab-content" >
      <label for="algorithm-select">æ¼”ç®—æ³•:</label>
      <select id="algorithm-select" onchange="handleSelection()">
        <option value="Qtable">Q-Learn</option>
        <option value="DQN">DQN</option>
      </select>   
      <br><br>
      <!-- <label>Q-Learning æ›´æ–°å…¬å¼ï¼š</label><br>
      <img src="q_learning_formula.png" alt="Q-learning æ›´æ–°å…¬å¼">
      <br><br> -->
      <label for="learning-rate-slider">å­¸ç¿’ç‡ (Î±):</label>
      <input id="learning-rate-slider" type="range" min="0.01" max="1" step="0.01" value="0.1" 
             oninput="updateValue('Alpha', this.value)">
      <span class="value-display" id="alpha-value">0.1</span>
      <br>
      
      <label for="discount-factor-slider">æŠ˜æ‰£ç‡ (Î³):</label>
      <input id="discount-factor-slider" type="range" min="0" max="1" step="0.01" value="0.95" 
             oninput="updateValue('Gamma', this.value)">
      <span class="value-display" id="gamma-value">0.95</span>
      <br>
      
      <label for="exploration-rate-slider">æ¢ç´¢ç‡ (Îµ):</label>
      <input id="exploration-rate-slider" type="range" min="0" max="1" step="0.01" value="0.2" 
             oninput="updateValue('Epsilon', this.value)">
      <span class="value-display" id="epsilon-value">0.2</span>
      <br>
      
      <label for="optimism-slider">æ¨‚è§€å€¼ (Ïˆ):</label>
      <input id="optimism-slider" type="range" min="-1" max="1" step="0.1" value="0" 
             oninput="updateValue('Psi', this.value)">
      <span class="value-display" id="psi-value">0</span>
      <br><br>
      
      <label for="delay-slider">å»¶é²é‡(ms):</label>
      <input id="delay-slider" type="range" min="10" max="100" step="10" value="50" 
             oninput="updateValue('delayTime', this.value)">
      <span class="value-display" id="delaytime-value">50</span>
      <!-- ç¬¬ä¸€å€ï¼šCumulative Reward Chart -->
      <div id="p1-rewards-chart" style="width: 600px; height: 200px;"></div>
      <div id="p1-episode-reward" style="width: 600px; height: 200px;"></div>
      <div id="p1-episode-steps" style="width: 600px; height: 200px;"></div>
    

    

    </div>
    <!-- 2. p1-blocks -->
    <div id="p1-qtable" class="sub-tab-content">
      <!-- ç¬¬ä¸‰å€ï¼šæŒ‰éˆ• -->
      <div style="width: 100%; ">
        <button onclick="exportQtable()" style="margin: 5px ;">Export Q-table</button>
        <input type="file" style="margin: 5px ;" id="importQtableInput" accept=".json,.txt" 
       onchange="importQtable(event)" />
      </div>
      <!-- ç¬¬äºŒå€ï¼šQ-Table Heatmap -->
      <div id="p1-qValues-chart" style="width: 600px; height: 300px;"></div>
    </div>

    <div id="p1-blocks" class="sub-tab-content">
      <!--<div id="blockly-container">-->
        <div id="p1-blocklyDiv"></div>
      <!--</div>-->
    </div>
    <!-- 3. p1-logs -->
    <div id="p1-logs" class="sub-tab-content">
    
    </div>
    
    
    
    

    <!-- 4. p2-blocks -->
    <div id="p2-blocks" class="sub-tab-content" >
      <div id="p2-blocklyDiv"></div>
    </div>
    <!-- 5. p2-config -->
    <div id="p2-config" class="sub-tab-content" >
      <div style="width:100%; height: 33%">
        <canvas id="p2-rewards-chart"></canvas>
        
      </div>
      
      <div style="width:100%; height: 33%">
        <canvas id="p2-qValues-chart"></canvas>
      </div>
    </div>
    <!-- 6. p2-logs -->
    <div id="p2-logs" class="sub-tab-content" >
    </div>
    
    
  </div>

  <!-- (å¯é¸) jQuery UI Dialog ç”¨æ–¼é¡¯ç¤º Q å€¼åœ–è¡¨çš„å½ˆçª— (è‹¥è¦ç”¨å½ˆçª—) -->


  <!-- ================================ -->
  <!-- JS å€æ®µï¼šåŒ…æ‹¬ å…¨å±åˆ‡æ›ã€å¤š Tabs æ§åˆ¶ã€Q-Learningç¨‹å¼é‚è¼¯ã€Blocklyåˆå§‹è¨­å®š ç­‰ -->
  <!-- ================================ -->
  <script>
    /***************************************************
     * [1] å…¨å± / åŠå± åˆ‡æ›åŠŸèƒ½
     ***************************************************/
    const leftPanel = document.getElementById("leftPanel");
    const rightPanel = document.getElementById("rightPanel"); // å–å¾—å³å´é¢æ¿
    const fullscreenButton = document.getElementById("toggleFullscreen");

    fullscreenButton.addEventListener("click", () => {
      if (leftPanel.classList.contains("fullscreen")) {
        // è‹¥ç›®å‰å…¨å±ï¼Œå‰‡æ¢å¾©
        leftPanel.classList.remove("fullscreen");
        rightPanel.style.display = "flex";
        fullscreenButton.textContent = "ğŸ•¹ï¸å…¨å±";
      } else {
        // é€²å…¥å…¨å±
        leftPanel.classList.add("fullscreen");
        rightPanel.style.display = "none"; // éš±è—å³å´é¢æ¿
        fullscreenButton.textContent = "ğŸ§ªåŠå±";
      }
    });

    /***************************************************
     * [2] å·¦å´ï¼šè¼‰å…¥/æš«åœ/ç¹¼çºŒ ç­‰æ§åˆ¶
     ***************************************************/
    const loadGameBtn = document.getElementById("loadGame");
    const gameUrlInput = document.getElementById("gameUrlInput");
    const gameIframe = document.getElementById("game-iframe");
    const togglePauseBtn = document.getElementById("togglePause");
    const toggleAccelBtn = document.getElementById("toggleAccel");

    loadGameBtn.addEventListener("click", () => {
      const url = gameUrlInput.value.trim();
      if (url) {
        gameIframe.src = url;
      }
      isPaused = false;
      togglePauseBtn.textContent = "â¸ï¸æš«åœ";
      // gameIframe.addEventListener("load", () => {
      //   // const iframe = document.getElementById("game-iframe");
      //   gameIframe.contentWindow.postMessage({ type: "questInfo" }, "*");
      // }, { once: true }); // ä½¿ç”¨ { once: true } ç¢ºä¿äº‹ä»¶åƒ…åŸ·è¡Œä¸€æ¬¡
    });

    let isPaused = false;
    togglePauseBtn.addEventListener("click", () => {
      if (!isPaused) {
        // é€™è£¡å¯åšæš«åœéŠæˆ² or åœæ­¢è¨“ç·´çš„å‹•ä½œ
        gameIframe.contentWindow.postMessage({ type: "pause" }, "*");
        togglePauseBtn.textContent = "â–¶ï¸ç¹¼çºŒ";

      } else {
        // é€™è£¡å¯åšæ¢å¾©éŠæˆ² or ç¹¼çºŒè¨“ç·´çš„å‹•ä½œ
        gameIframe.contentWindow.postMessage({ type: "pause" }, "*");
        gameIframe.contentWindow.postMessage({ type: "action",action:0}, "*");
        console.log('keep go')
        togglePauseBtn.textContent = "â¸ï¸æš«åœ";
      }
      isPaused = !isPaused;
    });

    let isAccel = false;
    toggleAccelBtn.addEventListener("click", () => {
      if (!isAccel) {
        // é€™è£¡å¯åšæš«åœéŠæˆ² or åœæ­¢è¨“ç·´çš„å‹•ä½œ
        gameIframe.contentWindow.postMessage({ type: "accel" }, "*");
        toggleAccelBtn.textContent = "ğŸ¢æ­£å¸¸";
        delayTime/=10
      } else {
        // é€™è£¡å¯åšæ¢å¾©éŠæˆ² or ç¹¼çºŒè¨“ç·´çš„å‹•ä½œ
        gameIframe.contentWindow.postMessage({ type: "accel" }, "*");
        toggleAccelBtn.textContent = "ğŸš€åŠ é€Ÿ";
        delayTime*=10
      }
      isAccel = !isAccel;
    });

    /***************************************************
     * [3] å¤š Agent å¤š Tabs åˆ‡æ›
     ***************************************************/
    const subTabLinks = document.querySelectorAll(".sub-tab-link");
    const subTabContents = document.querySelectorAll(".sub-tab-content");

    subTabLinks.forEach(link => {
      link.addEventListener("click", () => {
        // å…ˆç§»é™¤å…¨éƒ¨ active
        subTabLinks.forEach(l => l.classList.remove("active"));
        subTabContents.forEach(c => c.classList.remove("active"));

        // å•Ÿç”¨ç•¶å‰è¢«é»æ“Šçš„
        link.classList.add("active");
        const target = link.getAttribute("data-subtab");
        document.getElementById(target).classList.add("active");
        
            // æª¢æŸ¥æ˜¯å¦éœ€è¦é‡æ–°æ¸²æŸ“ Blockly
            if (target === "p1-blocks" && workspace1) {
              Blockly.svgResize(workspace1);
            }
            if (target === "p2-blocks" && workspace2) {
              Blockly.svgResize(workspace2);
            }
      });
    });
    
    
    // å¿«é€Ÿè¼‰å…¥éŠæˆ²æŒ‰éˆ•
    document.querySelectorAll('.quick-load-button').forEach(button => {
      button.addEventListener('click', () => {
        const url = button.getAttribute('data-url');
        if (url) {
          gameUrlInput.value= url
          gameIframe.src = url; // è¨­å®š iframe çš„ src
        }
        isPaused = false;
        togglePauseBtn.textContent = "â¸ï¸æš«åœ";
      });
    });



    /***************************************************
     * [4] Blockly åˆå§‹åŒ–
     ***************************************************/
    var workspace1 = Blockly.inject('p1-blocklyDiv', {
      toolbox: 
        `<xml>
          <block type="controls_repeat_ext"></block>
          <block type="math_number"></block>
          <block type="math_arithmetic"></block>
          <block type="logic_compare"></block>
          <block type="variables_get"></block>
          <block type="variables_set"></block>
          <block type="controls_if"></block>
          <block type="text_print"></block>
         </xml>`,
      trashcan: true,
      theme: Blockly.Themes.Zelos,
      renderer: 'thrasos',
    });

    // é è¼‰ä¸€äº›ç©æœ¨
    const initialBlocks = 
      `<xml>
        <block type="controls_repeat_ext" x="20" y="20">
          <value name="TIMES">
            <shadow type="math_number">
              <field name="NUM">5</field>
            </shadow>
          </value>
          <statement name="DO">
            <block type="text_print">
              <value name="TEXT">
                <shadow type="text">
                  <field name="TEXT">Q-Learning</field>
                </shadow>
              </value>
            </block>
          </statement>
        </block>
      </xml>`;
    loadInitialBlocks(initialBlocks, workspace1);

    function loadInitialBlocks(xmlText, workspace) {
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
      Blockly.Xml.domToWorkspace(xmlDoc.documentElement, workspace);
    }
    
    
    var workspace2 = Blockly.inject('p2-blocklyDiv', {
      toolbox: 
        `<xml>
          <block type="controls_repeat_ext"></block>
          <block type="math_number"></block>
          <block type="math_arithmetic"></block>
          <block type="logic_compare"></block>
          <block type="variables_get"></block>
         </xml>`,
      trashcan: true,
      theme: Blockly.Themes.Zelos,
      renderer: 'thrasos',
    });
    
    
        // // é è¼‰ä¸€äº›ç©æœ¨
    const initialBlocks2 = 
      `<xml>
        <block type="controls_repeat_ext" x="20" y="20">
          <value name="TIMES">
            <shadow type="math_number">
              <field name="NUM">5</field>
            </shadow>
          </value>
          <statement name="DO">
            <block type="text_print">
              <value name="TEXT">
                <shadow type="text">
                  <field name="TEXT">Q-Learning</field>
                </shadow>
              </value>
            </block>
          </statement>
        </block>
      </xml>`;
    loadInitialBlocks(initialBlocks, workspace2);

    /***************************************************
     * [5] Q-Learning ç›¸é—œè¨­å®š (ç¯„ä¾‹)
     ***************************************************/

    let QTable = {};
    let Alpha   = .1;  // å­¸ç¿’ç‡
    let Gamma   = 0.95; // æŠ˜æ‰£å› å­
    let Epsilon = .1;  // æ¢ç´¢ç‡
    let Psi     = 0;    // æ¨‚è§€å€¼   
    
    let delayTime =50

        // æ›´æ–° UI å’Œè®Šæ•¸
  function updateValue(parameter, value) {
  value = parseFloat(value);

  switch (parameter) {
    case "Alpha":
      Alpha = value;
      break;
    case "Gamma":
      Gamma = value;
      break;
    case "Epsilon":
      Epsilon = value;
      break;
    case "Psi":
      Psi = value;
      break;
    case "delayTime":
      delayTime = value;
      break;
    default:
      console.warn(`æœªçŸ¥åƒæ•¸: ${parameter}`);
  }

  // æ›´æ–°å°æ‡‰çš„ HTML é¡¯ç¤ºæ•¸å€¼
  let targetSpan = document.getElementById(parameter.toLowerCase() + "-value");
  if (targetSpan) {
    targetSpan.textContent = value;
  }

  console.log(`${parameter} æ›´æ–°ç‚º ${value}`);
  console.log([Alpha,Gamma,Epsilon,Psi,delayTime])
}


    // Q å€¼æ›´æ–°
    function qTableUpdate(prevS, prevA, r, nextS,nextA) {
      // åˆå§‹åŒ–ç•¶å‰ç‹€æ…‹å’Œä¸‹ä¸€ç‹€æ…‹çš„ Q å€¼ç©ºé–“
      if (!QTable[prevS]) QTable[prevS] = Array(action_size).fill(0);
      if (!QTable[nextS]) QTable[nextS] = Array(action_size).fill(0);

      
      // è¨ˆç®—ä¸‹ä¸€ç‹€æ…‹çš„æœ€å¤§å€¼å’Œæœ€å°å€¼
      let maxQNext = 0; // åˆå§‹åŒ–ä¸ºé»˜è®¤å€¼
      let minQNext = 0;
      if (QTable[nextS] && QTable[nextS].length > 0) {
        maxQNext = Math.max(...QTable[nextS]);
        minQNext = Math.min(...QTable[nextS]);
      }
      
      let actualQNext = QTable[nextS][nextA] || 0; // å¯¦éš›é¸æ“‡çš„å‹•ä½œ Q å€¼
      
      
      // æ ¹æ“š Î» çš„å€¼è¨ˆç®—ç›®æ¨™ Q å€¼
      let targetQ = (1 - Math.abs(Psi)) * actualQNext +
                    Math.max(0, Psi) * maxQNext +
                    Math.max(0, -Psi) * minQNext;
                    
                    
      if (isNaN(targetQ)) {
        console.error("Invalid Q update detected.", { QTable,nextS ,actualQNext , maxQNext , minQNext});
      }
      // è¨ˆç®— Q å€¼æ›´æ–°
      let oldQ = QTable[prevS][prevA] || 0;
      let newQ = oldQ + Alpha * (r + Gamma * targetQ - oldQ);
      
      
      // æª¢æŸ¥æ•¸æ“šæœ‰æ•ˆæ€§ï¼Œé˜²æ­¢ NaN
      
      if (isNaN(oldQ)) {
        console.error(QTable[prevS][prevA]);
      }
      if (isNaN(newQ)) {
        console.error("Invalid Q update detected.", {oldQ , Alpha , r , Gamma , targetQ});
      }
    
      // æ›´æ–° Q è¡¨
      QTable[prevS][prevA] = newQ;
    }
    
    // Îµ-greedy é¸æ“‡å‹•ä½œ
    function eGreedyChooseAction(stateKey) {
      if (Math.random() < Epsilon ||  !QTable[stateKey]) {
        return Math.floor(Math.random() * action_size);
      } else {
        if (!QTable[stateKey]){
          console.warn(`QTable[${stateKey}] æœªåˆå§‹åŒ–ï¼Œå°‡è‡ªå‹•åˆå§‹åŒ–ã€‚`);
          QTable[stateKey] = Array(action_size).fill(0);
        }
        let qVals = QTable[stateKey];
        let maxQ  = Math.max(...qVals);
        let chosenAction = qVals.indexOf(maxQ);
        if (chosenAction === -1) {
          console.error("ç„¡æ³•æ‰¾åˆ°æœ€å¤§ Q å€¼çš„ç´¢å¼•ï¼ŒqVals:", qVals, "maxQ:", maxQ);
        }
        return chosenAction;
      }
    }

         

    /***************************************************
     * [6] çˆ¶/å­é é¢ postMessage é€šè¨Šï¼š
     *     æ¥æ”¶å­é é¢ (éŠæˆ²)å‚³å›çš„ (reward, state)ï¼Œä¸¦å›å‚³å‹•ä½œ
     ***************************************************/
    let stateRange = []; 
    let numBins = [];

    // è¨ˆç®—ç•¶ä¸‹ç‹€æ…‹å°æ‡‰åˆ°Qè¡¨çš„éµå€¼
    function getStateKey(stateValues) {
      let indices = []; // ç”¨æ–¼å„²å­˜æ¯å€‹ç¶­åº¦çš„é›¢æ•£åŒ–ç´¢å¼•
      // console.log(stateValues)
      stateValues.forEach((value,dim) => {
        const bucketIdx = getBucketIndex(value,dim);
        // å°‡ç´¢å¼•åŠ å…¥é™£åˆ—
        indices.push(bucketIdx); 
      });
      // ç´¢å¼•è½‰æˆå­—ä¸²æ¨™ç±¤
      return indices.join("_");
    }
    
    function getBucketIndex(value,dim){
        // è¨­å®šé è¨­ç¯„åœ
        let min = 0, max = 100;
        // å–å¾—è©²ç‹€æ…‹æœ‰æ•ˆç¯„åœ
        if (stateRange[dim]) {
          min = stateRange[dim].min;
          max = stateRange[dim].max;
        }
        // è¨ˆç®—æ¡¶çš„å¤§å°
        let binSize = (max - min) / numBins[dim]; 
        // é™åˆ¶å€¼åœ¨ç¯„åœå…§
        let clipped = Math.max(min, Math.min(max, value)); 
        // è¨ˆç®—ç´¢å¼•
        let idx = Math.floor((clipped - min) / binSize);
        // ç¢ºä¿ç´¢å¼•åœ¨åˆæ³•ç¯„åœå…§
        idx = Math.min(Math.max(idx, 0), numBins[dim] - 1); 
        
        return idx;
    }
    
    
    let stateInfo
    let actionInfo
    let state_size  
    let action_size   
    
    // æ¯ç•¶éŠæˆ²é é¢è¼‰å…¥å®Œæˆï¼Œå°±è©¢å•éŠæˆ²è³‡è¨Š
    gameIframe.addEventListener("load", () => {
      gameIframe.contentWindow.postMessage({ type: "questInfo" }, "*");
    });     
     
    window.addEventListener("message", (event) => {
      const message = event.data;
      
      if (message.type === "gameInfo") {
        stateInfo=message.stateInfo
        actionInfo=message.actionInfo
        writeLog(1,stateInfo)  
        writeLog(1,actionInfo)         
        state_size=stateInfo.length
        action_size=actionInfo[0].level
        
        // åƒ¹å€¼å‹ç®—æ³•å°ˆå±¬
        QTable = {};     // æ¸…ç©ºQè¡¨
        stateRange = []; // æ¸…ç©ºç‹€æ…‹ç¯„åœ
        numBins = [];    // æ¸…ç©ºæ¯è»¸æ¡¶æ•¸
        message.stateInfo.forEach((info) => {
          stateRange.push({ min: info.min, max: info.max });
          if(info.bin){
            numBins.push(info.bin);
          }else{
            numBins.push(20); // é è¨­æ¯å€‹ç‹€æ…‹åˆ†æˆ 20 æ¡¶ï¼Œå¯æ ¹æ“šéœ€æ±‚èª¿æ•´
          }
        });
        
        // ç™¼é€ç¬¬ä¸€å€‹å‹•ä½œ
        gameIframe.contentWindow.postMessage({ type: "action", action: 0 }, "*");
      }

    });   
      
    let currentState 
    let prevAction,prevStateKey
    let nextAction,nextStateKey
    let reward  
    let rewardPerSecond = 0; // ç”¨æ–¼ç•«çå‹µåœ–è¡¨ 
    let episodeCount = 1
    let episodeReward = 0 
    let episodeSteps = 0
    
    window.addEventListener("message", (event) => {
      const message = event.data;  
      // å¾å­é é¢æ‹¿åˆ°å ±é…¬èˆ‡ç‹€æ…‹
      if (message.type === "reward_state") {
        // æ›´æ–°ç¬é–“å ±é…¬
        reward = message.reward;
        // åŠ å…¥æ¯ç§’å ±é…¬ç´¯è¨ˆ
        rewardPerSecond += message.reward;
        // åŠ å…¥å›åˆå ±é…¬ç´¯è¨ˆ
        episodeReward += message.reward;
        // å›åˆæ­¥æ•¸+1
        episodeSteps += 1;
        // console.log(reward,rewardPerSecond)
        // å–å¾—ç•¶ä¸‹ç‹€æ…‹å°æ‡‰åˆ°Qè¡¨çš„éµå€¼
        currentState=message.state
        nextStateKey = getStateKey(message.state);
        // console.log(message.state,nextStateKey)
        // é¸æ“‡ä¸‹ä¸€æ¬¡å‹•ä½œ
        nextAction = eGreedyChooseAction(nextStateKey);
        // æ›´æ–°Qè¡¨
        if (reward !== null  && 
        // prevActionå¿…é ˆæ˜¯æ­£æ•´æ•¸
        Number.isInteger(prevAction) && prevAction >= 0) {
          qTableUpdate(prevStateKey, prevAction, reward, nextStateKey,nextAction);
        }
        // ç¹¼æ‰¿ç‹€æ…‹èˆ‡å‹•ä½œè³‡è¨Š
        prevStateKey = nextStateKey;
        prevAction   = nextAction;
        // console.log(nextAction)


        // å›å‚³å‹•ä½œçµ¦å­é é¢
        if(isPaused){return}
        setTimeout(() => {
          gameIframe.contentWindow.postMessage({
            type: "action",
            action: prevAction
          }, "*");
        // æ•…æ„è¨­ç½®çš„å»¶é²æ™‚é–“
        }, delayTime);
      }

      
      if (message.type === "endEpisode"){
        console.log('Episode'+episodeCount)
        console.log('episodeReward='+episodeReward)
        console.log('episodeSteps='+episodeSteps)
        updateEpisodeChart()
        episodeCount += 1
        episodeReward=0
        episodeSteps=0
        
      }
    });
    
    
    /***************************************************
     * [7] ARS (Action, Reward, State) æ—¥èªŒç´€éŒ„
     ***************************************************/


    let lastTime = null;
    
    function updateARSLog(agentId,action, reward, state) {
      const now = new Date();
      let dt = lastTime ? now - lastTime : 0;
      lastTime = now;
      let sIndex = getStateKey(state);
    
      // Create the log entry
      const logEntry = `dt=${dt}ms, A=${action}, R=${reward}, state=${state}, sIndex=${sIndex}`;
    
      // Write the log for the specified agent
      writeLog(agentId, logEntry);
    }
    
    function writeLog(agentId, logEntry) {
      // Get the log element for the specified agent
      const logElement = document.getElementById(`p${agentId}-logs`);
      if (!logElement) {
        console.error(`Log element for agent ${agentId} not found.`);
        return;
      }
    
      // Append the log entry
      logElement.textContent += (logElement.textContent ? "\n" : "") + logEntry;
    
      // Automatically scroll to the bottom
      logElement.scrollTop = logElement.scrollHeight;
    }


    
    
/***************************************************
 * [8] Rewards Chart  
 ***************************************************/
    let rewardsChart;
    let rewardData = [];
    let rewardLabels = [];

    // åˆå§‹åŒ– Rewards å›¾è¡¨
    function initRewardsChart() {
      const layout = {
        title: 'Reward Flow',
        xaxis: { title: 'Time (s)' },
        yaxis: { title: 'Reward per Second' },
        margin: { t: 30, b: 40, l: 50, r: 20 }  // èª¿æ•´ margin è®“åœ–è¡¨æ’æ»¿ div
      };

      Plotly.newPlot('p1-rewards-chart', [{
        x: rewardLabels,
        y: rewardData,
        mode: 'lines',
        fill: 'tozeroy',
        line: { color: 'rgba(54, 162, 235, 1)' },
      }], layout);
    }
    let startTime=Date.now()
    // æ›´æ–° Rewards å›¾è¡¨çš„å‡½æ•°
    function updateRewardsChart() {
      
      const currentTime = ((Date.now() - startTime) / 1000).toFixed(1); // è®¡ç®—ç»è¿‡æ—¶é—´
      rewardLabels.push(currentTime);
      rewardData.push(rewardPerSecond);
      // console.log(rewardPerSecond)

      // ä¿è¯ rewardLabels å’Œ rewardData çš„æ•°é‡å§‹ç»ˆä¸€è‡´
      if (rewardData.length > 60) {
        rewardLabels.shift(); // ç§»é™¤æœ€æ—§çš„æ—¶é—´ç‚¹
        rewardData.shift();   // ç§»é™¤æœ€æ—§çš„æ•°æ®
      }

      // æ›´æ–°å›¾è¡¨
      Plotly.update('p1-rewards-chart', {
        x: [rewardLabels],
        y: [rewardData],
      });

      // é‡ç½®ç´¯ç§¯ Reward
      rewardPerSecond = 0;
    }

    // åˆå§‹åŒ–å›¾è¡¨
    initRewardsChart();

    // æ¨¡æ‹Ÿæ¯ç§’æ›´æ–°ä¸€æ¬¡å›¾è¡¨
    // let rewardPerSecond = 0; // åˆå§‹åŒ–ç´¯è®¡ Reward
    setInterval(() => {
      // rewardPerSecond += Math.random() * 10 - 5; // æ¨¡æ‹Ÿç´¯ç§¯ Reward çš„å˜åŒ–
      updateRewardsChart();
    }, 1000);
    
/*************************************************** 
 ***************************************************/   
     // åˆå§‹åŒ– Plotly åœ–è¡¨
       // åˆå§‹åŒ–æ•¸æ“š
  let episodeIndex = [];  // X è»¸: å›åˆç·¨è™Ÿ
  let episodeStepsData = []; // Y è»¸: æ¯å›åˆæ­¥æ•¸
  let episodeRewardData = []; // Y è»¸: æ¯å›åˆç´¯è¨ˆ Reward
  // let episodeCount = 0; // ç”¨æ–¼è¨ˆæ•¸å›åˆæ•¸


  // åˆå§‹åŒ– Reward åœ–è¡¨
Plotly.newPlot("p1-episode-reward", [{
  x: episodeIndex,
  y: episodeRewardData,
  type: 'bar'
}], {
  title: {
    text: "æ¯å›åˆç´¯ç© Reward",
    font: { size: 18 },
    yanchor: "top",
    y: 0.95,
    pad: { b: 0 }
  },
  xaxis: { title: "å›åˆæ•¸ (Episode)" },
  yaxis: { title: "ç´¯ç© Reward" },
  margin: { t: 30, b: 40, l: 50, r: 20 }
}); 


  Plotly.newPlot("p1-episode-steps", [{
    x: episodeIndex,
    y: episodeStepsData,
    type: 'bar'
  }], {
    title: {
    text: "æ¯å›åˆç´¯ç©æ­¥æ•¸",
    font: { size: 18 },
    yanchor: "top",  // è®“æ¨™é¡Œè²¼è¿‘åœ–è¡¨
    y: 0.95,         // æ§åˆ¶æ¨™é¡Œçš„å‚ç›´ä½ç½®ï¼Œ0~1 ä¹‹é–“ (è¶Šæ¥è¿‘ 1 è¶Šä¸Šæ–¹)
    pad: { b: 0 }    // ç¸®çŸ­æ¨™é¡Œèˆ‡åœ–è¡¨çš„é–“è·
  },
    xaxis: { title: "å›åˆæ•¸ (Episode)" },
    yaxis: { title: "æ­¥æ•¸ (Steps)" },
    margin: { t: 30, b: 40, l: 50, r: 20 }  // èª¿æ•´ margin è®“åœ–è¡¨æ’æ»¿ div
  }); 
    
  function updateEpisodeChart(){
    episodeIndex.push(episodeCount);
    episodeStepsData.push(episodeSteps);
    episodeRewardData.push(episodeReward);

    // æ›´æ–° Reward åœ–è¡¨
    Plotly.update("p1-episode-reward", {
      x: [episodeIndex],
      y: [episodeRewardData]
    });
    // æ›´æ–° Steps åœ–è¡¨
    Plotly.update("p1-episode-steps", {
      x: [episodeIndex],
      y: [episodeStepsData]
    });
  }

/***************************************************
 * [9] QTable Chart  
 ***************************************************/
/****************************************************************
 * 1) HSVâ†’RGB: å°‡ (h, s, v) è½‰æ›æˆ rgb(r,g,b)
 ****************************************************************/
function hsvToRgb(h, s, v) {
  // h: [0, 360], s: [0,1], v: [0,1]
  const c = v * s;
  const x = c * (1 - Math.abs((h / 60) % 2 - 1));
  const m = v - c;
  let r, g, b;
  if (h < 60) {
    r = c; g = x; b = 0;
  } else if (h < 120) {
    r = x; g = c; b = 0;
  } else if (h < 180) {
    r = 0; g = c; b = x;
  } else if (h < 240) {
    r = 0; g = x; b = c;
  } else if (h < 300) {
    r = x; g = 0; b = c;
  } else {
    r = c; g = 0; b = x;
  }
  r = Math.round((r + m) * 255);
  g = Math.round((g + m) * 255);
  b = Math.round((b + m) * 255);
  return `rgb(${r},${g},${b})`;
}

/****************************************************************
 * 2) çµ¦å®š (gap, bestAction) â†’ å‚³å›å°æ‡‰æ¼¸å±¤è‰²
 *    - action=0 => hue=0Â° (ç´…) 
 *    - action=1 => hue=180Â° (é’)
 *    - gap=0 => ç™½è‰², gapâ‰¥gapMax => ç´”è‰²
 ****************************************************************/
 // é è¨­ gap æœ€å¤§å€¼ï¼Œç”¨æ–¼æ§åˆ¶æ¼¸å±¤é£½å’Œåº¦
const gapMax = 10;
 
/**
 * é€šç”¨è‘—è‰²å‡½å¼ï¼š
 * - gap: (æœ€ä½³ Q - ç¬¬äºŒä½³ Q)
 * - bestAction: æœ€ä½³å‹•ä½œç·¨è™Ÿ (0 ~ action_size-1)
 * - gapMax: gap è¶…éæ­¤å€¼æ™‚ï¼Œé£½å’Œåº¦è¦–ç‚º 1
 * - actionSize: ç¸½å‹•ä½œæ•¸
 *
 * è¦å‰‡ï¼š
 * 1) gap=0 => ç™½è‰²
 * 2) bestAction=0 => ä»¥é»‘è‰²è¡¨ç¤º (å¯ç”± ratio=gap/gapMax åšæ¼¸å±¤)
 * 3) å…¶é¤˜å‹•ä½œ => åœ¨è‰²ç’°ä¸Šå¹³åˆ†
 *    ä¾‹å¦‚ action=1 => hue=0Â°, action=2 => hue=120Â°, action=3 => hue=240Â° (è‹¥ actionSize=4)
 *    gapè¶Šå¤§ => é£½å’Œåº¦è¶Šé«˜ => é¡è‰²æ›´ç´”
 */

function colorByGapAndBest(gap, bestAction, gapMax) {
  // å…ˆè¨ˆç®— 0..1 çš„ ratio
  let ratio = Math.max(0, Math.min(gap / gapMax, 1));

  // (1) gap=0: è¡¨ç¤ºå‹•ä½œåƒ¹å€¼ç„¡å·®ï¼Œç›´æ¥ç™½è‰²
  if (ratio === 0) {
    return 'rgb(255,255,255)';
  }

  // (2) è‹¥å‹•ä½œ 0 = ã€Œä¸å‹•ä½œã€ï¼Œç”¨é»‘è‰² (å¯éš¨ gap è®ŠåŒ–åœ¨ç™½~é»‘ä¹‹é–“)
  if (bestAction === 0) {
    // ç™½(255,255,255) â†’ é»‘(0,0,0) åšç·šæ€§æ’å€¼
    // ratio=1 => å…¨é»‘ï¼›ratio=0 => å…¨ç™½(ä¸Šé¢å·²ç¶“æ“‹æ‰)
    let c = Math.round(255 * (1 - ratio));
    return `rgb(${c},${c},${c})`;
  }

  // (3) å…¶é¤˜å‹•ä½œå‡å‹»åˆ†ä½ˆæ–¼ 360Â° çš„è‰²ç›¸ç’°
  // å‡è¨­ action=1,2,...,actionSize-1ï¼›ç¸½å…±æœ‰ (actionSize-1) ç¨®é¡è‰²
  // hueStep = 360 / (actionSize - 1)
  let hueStep = 360 / (action_size - 1);
  // hue  = (bestAction-1) * hueStep
  let hue = (bestAction - 1) * hueStep;

  // é£½å’Œåº¦ = ratioï¼›value = 1 => gapè¶Šå¤§ï¼Œé¡è‰²è¶Šé£½å’Œ
  let s = ratio;
  let v = 1;
  return hsvToRgb(hue, s, v);
}

/****************************************************************
 * 3) ç”¢ç”Ÿ Plotly Scatter çš„è³‡æ–™
 *    - åªé‡å°å‰å…©å€‹ç¶­åº¦ i, j => i in [0..numBins[0]-1], j in [0..numBins[1]-1]
 *    - æ¯å€‹ç¶²æ ¼å°æ‡‰ QTable["i_j"] = [q0, q1], è‹¥ä¸å­˜åœ¨ => ç™½è‰²
 ****************************************************************/
function generatePlotlyData2D() {
  const xvals = [];
  const yvals = [];
  const colors = [];
  const texts  = [];

  // å‡è¨­åªç”¨å‰å…©å€‹ç¶­åº¦ x, y
  const binsX = numBins[0];
  const binsY = numBins[1];

    
  for (let i = 0; i < binsX; i++) {
    for (let j = 0; j < binsY; j++) {
      
      // console.log(currentState[2],getBucketIndex(currentState[2],2))
      let i2=getBucketIndex(currentState[2],2)
      
      let stateKey = `${i}_${j}`; // èˆ‡ getStateKey([i,j]) ç”¢ç”Ÿçš„keyä¸€è‡´
      // if(!isNaN(i2)){stateKey = `${i}_${j}_${i2}`}
      if(!isNaN(i2)){stateKey = `0_${j}_${i}`}
      // console.log(stateKey)

      let qArr = QTable[stateKey]; // e.g. [q0, q1]
      if (!qArr || qArr.length < 2) {
        // è‹¥æŸ¥ç„¡è³‡æ–™æˆ–è³‡æ–™ä¸è¶³ï¼Œé¡¯ç¤ºç™½è‰²
        xvals.push(i);
        yvals.push(j);
        colors.push('rgb(255,255,255)');
        texts.push(`(i=${i}, j=${j})<br>No Data`);
      } else {
        // æœ‰ Q å€¼ => æ‰¾å‡ºæœ€ä½³èˆ‡ç¬¬äºŒä½³
        let sortedQ = qArr.slice().sort((a, b) => b - a); // ç”±å¤§åˆ°å°æ’åº
        let bestAction = qArr.indexOf(sortedQ[0]); // æœ€ä½³å‹•ä½œ
        let secondBestQ = sortedQ[1] !== undefined ? sortedQ[1] : sortedQ[0]; // ç¢ºä¿è‡³å°‘æœ‰å…©å€‹ Q å€¼æ¯”è¼ƒ
        let gap = sortedQ[0] - secondBestQ; // è¨ˆç®— Q å€¼å·®è·
        let col = colorByGapAndBest(gap, bestAction, gapMax, qArr.length); // è¨ˆç®—é¡è‰²

        xvals.push(i);
        yvals.push(j);
        colors.push(col);
      texts.push(`(i=${i}, j=${j})<br>Q=${qArr.map(q => q.toFixed(2)).join(', ')}<br>
                  gap=${gap.toFixed(2)}, best=${bestAction}`);
      }
    }
  }

  // å›å‚³ Plotly Scatter æ•¸æ“š
  return {
    x: xvals,
    y: yvals,
    text: texts,
    mode: 'markers',
    marker: {
      symbol: 'square', // æ–¹å½¢é»
      size: 25,         // å¯è¦–éœ€æ±‚èª¿æ•´
      color: colors,
      line: { width: 0 } // è‹¥ä¸è¦ç¶²æ ¼å¤–æ¡†å°±è¨­0
    },
    hoverinfo: 'text'
  };
}


    /************************************************
     * 5. ç”¨ Plotly ç•«åœ–
     ************************************************/
    let trace = generatePlotlyData2D();
    let layout = {
      title: 'Q-table Heatmap (Two Actions)',
      xaxis: {
        title: 'State Dimension X',
      },
      yaxis: {
        title: 'State Dimension Y',
        scaleratio: .5,
        // autorange: 'reversed', // è®“ Y è»¸ä¸Šä¸‹é¡›å€’
      },
      margin: { t: 30, b: 40, l: 50, r: 20 }  // èª¿æ•´ margin è®“åœ–è¡¨æ’æ»¿ div
    };

    Plotly.newPlot('p1-qValues-chart', [trace], layout);
    
    /************************************************
     * 6. æ¯éš” 2 ç§’éš¨æ©Ÿæ›´æ–° Qtable => æ›´æ–°åœ–è¡¨
     ************************************************/
    setInterval(() => {
      // é‡æ–°ç”Ÿæˆè³‡æ–™ï¼Œæ›´æ–° Plotly
      let newTrace = generatePlotlyData2D();
      Plotly.react('p1-qValues-chart', [newTrace], layout);
    }, 1000);
    
    
    
/***************************************************
 * [10] QTable Export / Import 
 ***************************************************/
 
 function exportQtable() {
  // å°‡ QTable åºåˆ—åŒ–ç‚º JSON å­—ä¸²
  const dataStr = JSON.stringify(QTable, null, 2); 
  // å»ºç«‹ä¸€å€‹ Blob ç‰©ä»¶ï¼Œå‹æ…‹ç‚º text/plain æˆ– application/json
  const blob = new Blob([dataStr], { type: "application/json" });
  // å»ºç«‹è‡¨æ™‚é€£çµä¸¦é»æ“Šï¼Œè§¸ç™¼ä¸‹è¼‰
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = "Qtable.json"; // æª”åå¯è‡ªè¨‚
  link.click();
  URL.revokeObjectURL(url);
}

function importQtable(evt) {
  const file = evt.target.files[0];me
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const fileContent = e.target.result;
      // è§£æ JSON
      const obj = JSON.parse(fileContent);
      
      // å¦‚æœæª”æ¡ˆè£¡åªæœ‰ QTable ç‰©ä»¶
      QTable = obj;
      
      console.log("QTable imported successfully:", QTable);
      // alert("QTable å·²æˆåŠŸè¼‰å…¥ï¼Œå¾ŒçºŒè¨“ç·´å¯æ²¿ç”¨æ­¤è¡¨æ ¼ã€‚");

    } catch (error) {
      console.error("Error parsing QTable file", error);
      // alert("ç„¡æ³•è§£ææ­¤ QTable æª”æ¡ˆ");
    }
  };
  reader.readAsText(file, "utf-8");
}
    
  </script>
</body>
</html>
